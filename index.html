<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Atrium ‚Äî Starter</title>
<meta name="description" content="Interactive Atrium map with seed characters, import/export, pan/zoom, and local persistence.">
<style>
  :root{
    --bg1:#0b0f1d; --bg2:#070a13;
    --panel:#0f1323; --panelB:#1c2240;
    --ink:#e8ecf3; --muted:#9aa4b5;
    --pathos:#ff7a93; --logos:#7cc4ff; --ethos:#ffd166; --eidolon:#c39bff; --unknown:#9fb0c3;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 70% 30%,#15192a 0%,#0b0e19 55%,#070811 100%);
       color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  header{position:fixed;top:12px;left:12px;right:12px;display:flex;gap:10px;z-index:10;align-items:center}
  h1{font-size:16px;margin:0;padding:8px 12px;background:#0f1323cc;border:1px solid var(--panelB);
     border-radius:12px;backdrop-filter:blur(4px)}
  .legend{display:flex;gap:8px;padding:6px 8px;background:#0f1323cc;border:1px solid var(--panelB);border-radius:12px}
  .dot{width:10px;height:10px;border-radius:50%}
  .row{display:flex;gap:8px;align-items:center}
  .toolbar{margin-left:auto;display:flex;gap:8px}
  .btn,select,input[type="search"]{background:#0f1323;border:1px solid var(--panelB);color:var(--ink);border-radius:10px;padding:8px 10px}
  .btn{cursor:pointer}
  canvas{position:fixed;inset:0;display:block}
  aside{position:fixed;right:12px;top:56px;bottom:12px;width:360px;background:#0f1323f2;border:1px solid var(--panelB);
        border-radius:16px;padding:14px;overflow:auto;backdrop-filter:blur(6px);z-index:9}
  aside[hidden]{display:none}
  .pill{display:inline-block;border:1px solid #2b355f;padding:2px 8px;border-radius:999px;margin-right:6px;color:var(--muted);font-size:12px}
  .kv{margin:8px 0}.kv b{display:block;color:#c7d2fe;font-size:11px;letter-spacing:.2px;text-transform:uppercase}
  #hint{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#0f1323cc;border:1px solid var(--panelB);
        border-radius:999px;padding:6px 12px;color:var(--muted);z-index:7}
  .footer{position:fixed;left:12px;bottom:12px;background:#0f1323cc;border:1px solid var(--panelB);border-radius:12px;padding:6px 10px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>üúÅ The Atrium</h1>
  <div class="legend">
    <div class="row"><span class="dot" style="background:var(--pathos)"></span><span>Pathos</span></div>
    <div class="row"><span class="dot" style="background:var(--logos)"></span><span>Logos</span></div>
    <div class="row"><span class="dot" style="background:var(--ethos)"></span><span>Ethos</span></div>
    <div class="row"><span class="dot" style="background:var(--eidolon)"></span><span>Greater Eidolon</span></div>
  </div>
  <div class="toolbar">
    <input id="search" type="search" placeholder="Search‚Ä¶ (name, text)" />
    <select id="filterZone"><option value="">Any Zone</option><option>Pathos</option><option>Logos</option><option>Ethos</option><option>Greater Eidolon</option><option>Unknown</option></select>
    <button class="btn" id="exportBtn">Export JSON</button>
    <label class="btn" for="importFile">Import JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
    <button class="btn" id="resetBtn" title="Reset to built‚Äëin seeds">Reset Seeds</button>
  </div>
</header>
<canvas id="bg"></canvas>
<canvas id="nodes"></canvas>
<aside id="pane" hidden>
  <div id="meta" class="pill">Entry</div>
  <h2 id="pName">‚Äî</h2>
  <div class="kv"><b>Zone</b><div id="pZone">‚Äî</div></div>
  <div class="kv"><b>Power</b><div id="pPower">‚Äî</div></div>
  <div class="kv"><b>Catharsis / Evolution</b><div id="pCath">‚Äî</div></div>
  <div class="kv"><b>Bio / Notes</b><div id="pBio">‚Äî</div></div>
</aside>
<div id="hint">Drag to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Click a node ‚Ä¢ Shift-click empty space to recenter</div>
<div class="footer">Autoloads seeds ‚Üí then localStorage ‚Üí then characters.json (if present)</div>

<script>
const STORAGE_KEY = 'atrium_v1';
const COLOR = { Pathos: css('--pathos'), Logos: css('--logos'), Ethos: css('--ethos'), 'Greater Eidolon': css('--eidolon'), Unknown: css('--unknown') };

// ---- Built-in seed data so the Atrium is NEVER empty ----
const SEED = {
  entries:[
    E('Robin','Character','Greater Eidolon',
      'Stay Gold ‚Äî produces controllable gold dust; blink via dust ‚ÄúChase‚Äù; beams; flash; access to Pathos/Logos/Ethos modes via Icarus link.',
      '(Future) Catharsis ‚Äî identity becomes unshakable; power expresses conviction.',
      'Gift‚Äëgiver learning real kindness; wants to atone.'),
    E('Icarus','Greater Eidolon','Ethos',
      'Wings of Freedom ‚Äî declare freedom from a concept; timer ends with catastrophic backlash proportional to the freedom.',
      '‚Äî','Ancient ambition choosing restraint; cursed by Reverse Index.'),
    E('Azalea','Character','Pathos',
      'Resonant Arsenal ‚Äî empathically reads emotions and forges weapons; form by Type, properties by Characteristic; power scales with understanding.',
      'Actualized Arsenal','Empath whose compassion is both strength and burden.')
  ]
};

// ---- Load order: localStorage ‚Üí characters.json ‚Üí seeds ----
(async function init(){
  let DATA = loadLocal();
  if(!DATA){ // try external file
    try{
      const r = await fetch('characters.json', {cache:'no-store'});
      if(r.ok){
        const j = await r.json();
        if(j && Array.isArray(j.entries)) DATA = j;
      }
    }catch{ /* ignore */ }
  }
  if(!DATA) DATA = SEED;
  start(DATA);
})();

function start(DATA){
  persist(DATA);
  build(DATA);
  wireUI(DATA);
}

// ---------- Canvas + Interaction ----------
const bg = document.getElementById('bg'), bctx = bg.getContext('2d');
const cv = document.getElementById('nodes'), ctx = cv.getContext('2d');
let W=innerWidth, H=innerHeight; resize(); addEventListener('resize', resize);

let nodes=[], scale=1, offset={x:W*0.5, y:H*0.5}, dragging=false, last={x:0,y:0}, hover=null, currentDATA=null;

function build(DATA){
  currentDATA = DATA;
  // spiral layout
  const R = Math.min(W,H)*0.38;
  const N = DATA.entries.length;
  nodes = DATA.entries.map((e,i)=>{
    const t = (N<=1)?0.5:(i/(N-1));
    const angle = t * Math.PI*5.2 + i*0.27;
    const r = 42 + t*R;
    const x = Math.cos(angle)*r, y = Math.sin(angle)*r;
    const rad = e.type==='Greater Eidolon'? 16 : 12;
    return { id: e.id || uid(), x, y, r: rad, ref:e, color: COLOR[e.zoneType] || COLOR.Unknown };
  });
}

let tick=0;
(function loop(){ tick++; drawBG(); draw(); requestAnimationFrame(loop); })();

function drawBG(){
  bctx.setTransform(1,0,0,1,0,0);
  bctx.globalAlpha = 0.22; bctx.fillStyle = '#0b0f1d'; bctx.fillRect(0,0,W,H);
  orb(bctx, W*0.65 + Math.cos(tick*0.003)*60, H*0.4 + Math.sin(tick*0.002)*40, Math.min(W,H)*0.45, '#1d2448', '#0c0f1f');
  orb(bctx, W*0.25, H*0.65, Math.min(W,H)*0.36, '#10162d', '#080a15');
}

function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);
  ctx.translate(offset.x, offset.y);
  ctx.scale(scale, scale);

  // spiral guide
  ctx.save(); ctx.globalAlpha = 0.12; ctx.strokeStyle = '#3a4364'; ctx.lineWidth=1/scale;
  ctx.beginPath(); let rr=8;
  for(let a=0; a<Math.PI*6; a+=0.12){ const x=Math.cos(a)*rr, y=Math.sin(a)*rr; a===0?ctx.moveTo(x,y):ctx.lineTo(x,y); rr+=3.2; }
  ctx.stroke(); ctx.restore();

  // nodes
  nodes.forEach(n=>{
    const alpha = passFilter(n.ref) ? 1 : 0.12;
    ctx.save(); ctx.globalAlpha = alpha;
    circle(n.x, n.y, n.r*2.2, rgba(n.color,0.18), true);
    circle(n.x, n.y, n.r, rgba(n.color,0.95), true);
    ctx.lineWidth = (n.ref.type==='Greater Eidolon'? 2.6 : 1.6)/scale;
    ctx.strokeStyle = rgba('#cbd5e1', 0.65);
    circle(n.x, n.y, n.r, null, false, true);
    ctx.fillStyle = 'rgba(8,10,16,.9)'; ctx.font = `${Math.max(9, n.r)}px Inter, system-ui`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const initials = (n.ref.name||'?').split(/\s+/).map(s=>s[0]).join('').slice(0,3).toUpperCase();
    ctx.fillText(initials, n.x, n.y+0.5);
    ctx.restore();
  });

  if(hover){
    const vx = hover.x*scale + offset.x, vy = hover.y*scale + offset.y;
    const text = `${hover.ref.name} ‚Äî ${hover.ref.zoneType || '‚Äî'}`;
    ctx.setTransform(1,0,0,1,0,0); const pad=8;
    ctx.font = '12px Inter, system-ui';
    const w = Math.ceil(ctx.measureText(text).width)+pad*2;
    const x = Math.min(Math.max(8, vx - w*0.5), W - w - 8), y = Math.max(48, vy - 26);
    rounded(ctx, x,y,w,22,8, '#0f1323f2', '#1c2240');
    ctx.fillStyle = '#cbd5e1'; ctx.fillText(text, x+pad, y+15);
  }
}

// interactions
cv.addEventListener('mousedown', e=>{ dragging=true; last.x=e.clientX; last.y=e.clientY; });
addEventListener('mouseup', ()=> dragging=false);
addEventListener('mousemove', e=>{
  if(dragging){ offset.x += (e.clientX-last.x); offset.y += (e.clientY-last.y); last.x=e.clientX; last.y=e.clientY; }
  hover = pick(e.clientX, e.clientY);
});
addEventListener('wheel', e=>{ const m=Math.exp(-e.deltaY*0.001); zoom(m, e.clientX, e.clientY); });
addEventListener('click', e=>{
  const n = pick(e.clientX, e.clientY);
  if(n && passFilter(n.ref)) openPane(n.ref);
  else if(e.shiftKey){ scale=1; offset.x=W*0.5; offset.y=H*0.5; }
});

// filters + import/export + reset
const search = document.getElementById('search');
const fZone = document.getElementById('filterZone');
search.oninput = ()=>{}; fZone.onchange = ()=>{};

document.getElementById('exportBtn').onclick = ()=> download(JSON.stringify(currentDATA,null,2), 'characters.json', 'application/json');
document.getElementById('importFile').onchange = ev=>{
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const json = JSON.parse(r.result);
      if(json && Array.isArray(json.entries)){
        persist(json); build(json);
      } else alert('Invalid file format: expected {"entries":[...]}');
    }catch(err){ alert('Import failed: '+err.message); }
  };
  r.readAsText(f);
};
document.getElementById('resetBtn').onclick = ()=>{ if(confirm('Reset local data to built‚Äëin seeds?')){ persist(SEED); build(SEED); } };

// pane
function openPane(e){
  const pane = document.getElementById('pane');
  pane.hidden = false;
  document.getElementById('meta').textContent = e.type || 'Entry';
  document.getElementById('pName').textContent = e.name || '‚Äî';
  document.getElementById('pZone').textContent = e.zoneType || '‚Äî';
  document.getElementById('pPower').textContent = e.power || '‚Äî';
  document.getElementById('pCath').textContent = e.catharsis || '‚Äî';
  document.getElementById('pBio').textContent = e.bio || '‚Äî';
}

// helpers
function E(name,type,zoneType,power,catharsis,bio){ return { id: uid(), name, type, zoneType, power, catharsis, bio }; }
function persist(data){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){} }
function loadLocal(){ try{ const s = localStorage.getItem(STORAGE_KEY); if(!s) return null; const j=JSON.parse(s); if(j && Array.isArray(j.entries)) return j; }catch(e){} return null; }
function pick(px,py){ const x = (px - offset.x)/scale, y = (py - offset.y)/scale; for(let i=nodes.length-1;i>=0;i--){ const n=nodes[i]; if(!passFilter(n.ref)) continue; const dx=x-n.x, dy=y-n.y; if(dx*dx+dy*dy<=n.r*n.r) return n; } return null; }
function passFilter(e){ const q=(search.value||'').toLowerCase(); if(fZone.value && e.zoneType!==fZone.value) return false; if(!q) return true; return [e.name,e.type,e.zoneType,e.power,e.catharsis,e.bio].join(' ').toLowerCase().includes(q); }
function resize(){ W=innerWidth; H=innerHeight; bg.width=W; bg.height=H; cv.width=W; cv.height=H; }
function orb(c,x,y,r,a,b){ const g=c.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,a); g.addColorStop(1,b); c.fillStyle=g; c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill(); }
function circle(x,y,r,fill,doFill,doStroke){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); if(doFill && fill){ ctx.fillStyle=fill; ctx.fill(); } if(doStroke){ ctx.stroke(); } }
function rounded(c,x,y,w,h,r,fill,stroke){ c.fillStyle=fill; c.strokeStyle=stroke; c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); c.fill(); c.stroke(); }
function zoom(mult, sx, sy){ const wx=(sx-offset.x)/scale, wy=(sy-offset.y)/scale; scale*=mult; offset.x = sx - wx*scale; offset.y = sy - wy*scale; }
function rgba(col,a){ if(typeof col==='number'){ const r=(col>>16)&255,g=(col>>8)&255,b=col&255; return `rgba(${r},${g},${b},${a})`; } if(col.startsWith('#')){ const v=parseInt(col.slice(1),16); const r=(v>>16)&255,g=(v>>8)&255,b=v&255; return `rgba(${r},${g},${b},${a})`; } return col.replace(')',`, ${a})`).replace('rgb(','rgba('); }
function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function uid(){ return Math.random().toString(36).slice(2,10); }
</script>
</body>
</html>